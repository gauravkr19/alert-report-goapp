<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Date Range Form</title>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
</head>

<body>

    <form action="/export" method="post">
        <input type="text" name="daterange" id="daterange" style="width: 300px;" />
        <button type="submit">Display Alerts</button>
    </form>

    <div class="navigation-pane">
        <p class="link"><a href="/books">All Alerts</a></p>
        <p class="link"><a href="/home">Select-Date</a></p>
        <button id="showRecordsBtn">Show Records</button>
    </div>

    <!-- Placeholder for table -->
    <div id="table-container">
        {{ template "table" . }}
    </div>

    <script type="text/javascript">
    $(function() {
        var start = moment().subtract(29, 'days');
        var end = moment();
        window.isTodaySelected = false; // Use window to make it global

        function cb(start, end, label) {
            $('#daterange').val(start.format('YYYY-MM-DD HH:mm:ss') + ' - ' + end.format('YYYY-MM-DD HH:mm:ss'));
            console.log("Selected Range Label: " + label);
            window.isTodaySelected = (label === 'Today');
        }

        $('#daterange').daterangepicker({
            timePicker: true,
            timePicker24Hour: true,
            timePickerSeconds: true,
            showDropdowns: true,        
            startDate: moment().startOf('hour'),
            endDate: moment().startOf('hour').add(32, 'hour'),
            minYear: 1901,
            maxYear: parseInt(moment().format('YYYY'), 10),
            ranges: {
                'Today': [moment().startOf('day'), moment().endOf('day')],
                'Yesterday': [moment().subtract(1, 'days').startOf('day'), moment().subtract(1, 'days').endOf('day')],
                'Last 7 Days': [moment().subtract(6, 'days').startOf('day'), moment().endOf('day')],
                'Last 30 Days': [moment().subtract(29, 'days').startOf('day'), moment().endOf('day')],
                'This Month': [moment().startOf('month'), moment().endOf('month')],
                'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            },
            locale: {
                format: 'YYYY-MM-DD HH:mm:ss'
            }
        }, cb);

        cb(start, end);
    });

    // showRecordsBtn listener
    $('#showRecordsBtn').on('click', function() {
        console.log("Show Records button clicked.");
        console.log("isTodaySelected: " + window.isTodaySelected);
        if (window.isTodaySelected) {
            establishWebSocket();
        } else {
            console.log("Please select 'Today' to show records.");
        }
    });


// Establish websocket
function establishWebSocket() {
    const websocketUrl = "ws://" + window.location.host + "/ws";
    const socket = new WebSocket(websocketUrl);

    socket.onopen = function(event) {
        console.log("WebSocket connection established.");
        const dateRange = $('#daterange').val();
        socket.send(JSON.stringify({
            messageType: "dateRange",
            dateRange: dateRange
        }));
    };

    socket.onmessage = function(event) {
        console.log("Received message from server:", event.data);
        try {
            const message = JSON.parse(event.data);
            if (message.messageType === "update") {
                updateTable(message.data);
            } else {
                console.error("Unexpected message type:", message.messageType);
            }
        } catch (e) {
            console.error("Error parsing JSON data:", e);
        }
    };

    socket.onerror = function(error) {
        console.error("WebSocket error:", error);
    };

    socket.onclose = function(event) {
        console.log("WebSocket connection closed.");
    };
}

// Update Table
function updateTable(data) {
    const tableBody = document.getElementById("myTable");
    tableBody.innerHTML = ""; // Clear the existing table body

    if (data === "NoData") {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 13; // Number of columns in your table
        cell.textContent = "No records found for the selected date range.";
        row.appendChild(cell);
        tableBody.appendChild(row);
        return;
    }

    if (!Array.isArray(data)) {
        console.error("Data is not an array:", data);
        return;
    }

    data.forEach(function(rowData) {
        const row = document.createElement("tr");
        for (const key in rowData) {
            const cell = document.createElement("td");
            cell.textContent = rowData[key];
            row.appendChild(cell);
        }
        tableBody.appendChild(row);
    });
}
</script>  

</body>
</html>

